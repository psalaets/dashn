#!/usr/bin/env node

var catstream = require('catstream');
var dashn = require('..');

var args = process.argv.slice();
args.shift(); // discard node :(
args.shift(); // discard script name

if (args[0] === '-e') args.shift(); // discard unused flag

var expression = args.slice(0, 1);
var filenames = args.slice(1);

var sink = dashn(makeWriteFunction(expression));

if (filenames.length) {
  var cat = catstream();
  cat.pipe(sink);
  cat.end(filenames.join('\n'));
} else {
  process.stdin.pipe(sink);
}

function makeWriteFunction(expression) {
  var body =
    "var log = console.log.bind(console);" +
    "var error = console.error.bind(console);" +
    "var line = data.toString();" +
    expression;
  return new Function('data', body);
}
